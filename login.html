<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Login | SEJIWA</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0F172A">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1048/1048953.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { --bg: #0F172A; --card: #1E293B; --accent: #2DD4BF; --text: #F8FAFC; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: radial-gradient(circle at top right, #1E293B, #0F172A);
            color: var(--text); 
            margin: 0; padding: 0;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 100vh; overflow: hidden;
        }

        .login-card {
            background: var(--card);
            padding: 35px 25px; 
            border-radius: 24px;
            width: 85%; max-width: 320px;    
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
            border: 1px solid #334155;
            text-align: center;
        }

        .logo-icon { font-size: 50px; color: var(--accent); margin-bottom: 15px; }
        h2 { margin: 0; font-size: 20px; font-weight: 800; letter-spacing: -0.5px; }
        p { color: #94a3b8; font-size: 13px; margin-bottom: 25px; }

        .input-group { position: relative; margin-bottom: 18px; text-align: left; }
        .input-group label { display: block; font-size: 10px; color: var(--accent); text-transform: uppercase; letter-spacing: 1.2px; margin-bottom: 6px; font-weight: 700; }
        
        .input-field {
            width: 100%; background: rgba(15, 23, 42, 0.6); border: 1px solid #334155;
            padding: 12px 14px; border-radius: 12px; color: white; outline: none;
            box-sizing: border-box; font-size: 16px;
        }
        .input-field:focus { border-color: var(--accent); }

        .toggle-password { position: absolute; right: 12px; top: 34px; cursor: pointer; color: #475569; }

        .btn-login {
            width: 100%; background: var(--accent); color: #0F172A; border: none;
            padding: 14px; border-radius: 12px; font-weight: 800; font-size: 14px;
            cursor: pointer; margin-top: 10px; text-transform: uppercase;
        }

        #loader { display: none; margin-top: 15px; color: var(--accent); font-size: 12px; }
        
        .copyright { margin-top: 25px; font-size: 10px; color: #475569; text-transform: uppercase; }
        .copyright span { color: var(--accent); }
    </style>
</head>
<body>

    <div class="login-card">
        <i class="fa-solid fa-qrcode logo-icon"></i>
        <h2>JIMPITAN DIGITAL</h2>
        <p>RT 04 DONGKELAN</p>

        <div class="input-group">
            <label>Username</label>
            <input type="text" id="user" class="input-field" placeholder="Masukkan username" autocomplete="off">
        </div>

        <div class="input-group">
            <label>Password</label>
            <input type="password" id="pass" class="input-field" placeholder="••••••••">
            <i class="fa-solid fa-eye-slash toggle-password" id="eyeIcon" onclick="togglePass()"></i>
        </div>

        <button class="btn-login" onclick="prosesLogin()">LOGIN MASUK</button>
        
        <div id="loader">
            <i class="fa-solid fa-circle-notch fa-spin"></i> Memverifikasi Akun...
        </div>
    </div>

    <div class="copyright">
        <span> © 2026 Sekawan Technologies</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIG FIREBASE SINGAPURA
        const firebaseConfig = {
            apiKey: "AIzaSyAxFU7HD_9uVHWGXEO0ZtJja6rdqKHurTk",
            authDomain: "jimpitan-sekawan.firebaseapp.com",
            projectId: "jimpitan-sekawan",
            storageBucket: "jimpitan-sekawan.firebasestorage.app",
            messagingSenderId: "634934433280",
            appId: "1:634934433280:web:abde3734bd277d3e9b2ae5",
            databaseURL: "https://jimpitan-sekawan-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // CEK APAKAH SUDAH LOGIN?
        const session = localStorage.getItem("jimpitan_user");
        if (session) {
            const userData = JSON.parse(session);
            window.location.href = (userData.role === "admin") ? "admin.html" : "petugas.html";
        }

        // FUNGSI LOGIN
        window.prosesLogin = async function() {
            const u = document.getElementById('user').value.toLowerCase().trim();
            const p = document.getElementById('pass').value;
            const loader = document.getElementById('loader');

            if(!u || !p) return alert("Username dan Password wajib diisi!");

            loader.style.display = "block";

            try {
                // Ambil data user dari node 'users/username'
                const userRef = ref(db, `users/${u}`);
                const snapshot = await get(userRef);

                if (snapshot.exists()) {
                    const data = snapshot.val();
                    
                    // Verifikasi Password
                    if (data.password === p) {
                        // Simpan ke LocalStorage
                        localStorage.setItem("jimpitan_user", JSON.stringify({
                            username: u,
                            role: data.role,
                            kelompok: data.kelompok
                        }));

                        // Redirect sesuai role
                        if(data.role === "admin") {
                            window.location.href = "admin.html";
                        } else {
                            window.location.href = "petugas.html";
                        }
                    } else {
                        alert("Password salah!");
                    }
                } else {
                    alert("Username tidak ditemukan!");
                }
            } catch (err) {
                console.error(err);
                alert("Gagal terhubung ke database!");
            } finally {
                loader.style.display = "none";
            }
        };

        // TOGGLE LIHAT PASSWORD
        window.togglePass = function() {
            const passInput = document.getElementById('pass');
            const eyeIcon = document.getElementById('eyeIcon');
            if (passInput.type === "password") {
                passInput.type = "text";
                eyeIcon.classList.replace('fa-eye-slash', 'fa-eye');
                eyeIcon.style.color = "var(--accent)";
            } else {
                passInput.type = "password";
                eyeIcon.classList.replace('fa-eye', 'fa-eye-slash');
                eyeIcon.style.color = "#475569";
            }
        };
    </script>
</body>
</html>
