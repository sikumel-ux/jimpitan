<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Management Center | SEJIWA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { --bg: #0F172A; --card: #1E293B; --accent: #2DD4BF; --text: #F8FAFC; --success: #2DD4BF; --danger: #F87171; --warning: #FBBF24; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; padding-bottom: 100px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid #334155; }
        .header h1 { font-size: 14px; margin: 0; color: var(--accent); font-weight: 800; text-transform: uppercase; }

        .filter-section { background: var(--card); padding: 12px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #334155; display: flex; gap: 10px; }
        select, input { flex: 1; background: #0F172A; color: white; border: 1px solid #334155; padding: 12px; border-radius: 10px; outline: none; font-size: 14px; box-sizing: border-box; }

        .table-container { background: var(--card); border-radius: 15px; overflow-x: auto; border: 1px solid #334155; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th, td { padding: 12px 10px; border: 1px solid #334155; text-align: center; }
        .nama-col { text-align: left; position: sticky; left: 0; background: #1E293B; z-index: 5; font-weight: bold; min-width: 130px; border-right: 2px solid #334155; }
        
        /* Floating Button & Menu */
        .fab-main { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; background: var(--accent); color: #0F172A; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 15px rgba(45,212,191,0.4); border: none; z-index: 100; cursor: pointer; }
        .fab-menu { position: fixed; bottom: 95px; right: 25px; display: none; flex-direction: column; gap: 10px; z-index: 99; }
        .btn-sub { background: var(--card); color: var(--accent); border: 1px solid var(--accent); padding: 12px 20px; border-radius: 30px; font-weight: bold; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; background: rgba(15,23,42,0.95); align-items: center; justify-content: center; }
        .modal-content { background: var(--card); padding: 20px; border-radius: 15px; width: 90%; max-width: 450px; border: 1px solid var(--accent); max-height: 85vh; overflow-y: auto; }
        
        .user-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #0F172A; border-radius: 8px; margin-bottom: 8px; border: 1px solid #334155; }
        .can-delete { color: var(--danger) !important; cursor: pointer; }
    </style>
</head>
<body>

    <div class="header">
        <h1 id="role-title">PANEL MANAGEMENT</h1>
        <button onclick="logout()" style="background:#334155; color:var(--danger); border:none; padding:8px 12px; border-radius:8px; font-weight:bold;">OUT</button>
    </div>

    <div class="filter-section">
        <select id="pilih-kelompok" onchange="loadAdminData()">
            <option value="">-- Cek Jadwal --</option>
            <option value="1">SENIN</option><option value="2">SELASA</option>
            <option value="3">RABU</option><option value="4">KAMIS</option>
            <option value="5">JUMAT</option><option value="6">SABTU</option>
            <option value="0">MINGGU</option>
        </select>
    </div>

    <div class="table-container">
        <table>
            <thead><tr id="head-tgl"><th class="nama-col">Nama Warga</th></tr></thead>
            <tbody id="body-rekap"><tr><td colspan="5" style="padding:40px;">Pilih hari untuk melihat data jimpitan.</td></tr></tbody>
        </table>
    </div>

    <div id="fab-container" style="display: none;">
        <div id="fab-list" class="fab-menu">
            <button class="btn-sub" onclick="openModal('warga')"><i class="fa-solid fa-user-tag"></i> + Tambah Warga</button>
            <button class="btn-sub" onclick="openModal('akun')"><i class="fa-solid fa-user-gear"></i> + Kelola Akun</button>
        </div>
        <button class="fab-main" onclick="toggleFab()"><i class="fa-solid fa-plus"></i></button>
    </div>

    <div id="modal-warga" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--accent)">Tambah Warga</h3>
            <input type="text" id="new-warga-nama" placeholder="Nama Warga Baru...">
            <button onclick="simpanWarga()" style="width:100%; padding:12px; background:var(--accent); border:none; border-radius:10px; font-weight:bold; margin-top:10px;">SIMPAN</button>
            <button onclick="closeModals()" style="width:100%; background:none; color:white; border:none; margin-top:15px;">Tutup</button>
        </div>
    </div>

    <div id="modal-akun" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--accent)">Kelola Akun Login</h3>
            <div style="background:#0F172A; padding:15px; border-radius:10px; margin-bottom:20px;">
                <input type="text" id="reg-user" placeholder="Username">
                <input type="text" id="reg-pass" placeholder="Password">
                <select id="reg-role">
                    <option value="petugas">Petugas Ronda</option>
                    <option value="admin">Admin Bendahara</option>
                    <option value="humas">Humas</option>
                </select>
                <input type="text" id="reg-kel" placeholder="Kelompok (senin/selasa/all)">
                <button onclick="simpanUser()" style="width:100%; padding:12px; background:var(--warning); border:none; border-radius:10px; font-weight:bold;">DAFTARKAN</button>
            </div>
            <div id="user-list-container"></div>
            <button onclick="closeModals()" style="width:100%; background:none; color:white; border:none; margin-top:15px;">Tutup</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, get, set, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAxFU7HD_9uVHWGXEO0ZtJja6rdqKHurTk",
            authDomain: "jimpitan-sekawan.firebaseapp.com",
            projectId: "jimpitan-sekawan",
            storageBucket: "jimpitan-sekawan.firebasestorage.app",
            messagingSenderId: "634934433280",
            appId: "1:634934433280:web:abde3734bd277d3e9b2ae5",
            databaseURL: "https://jimpitan-sekawan-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const user = JSON.parse(localStorage.getItem("jimpitan_user"));
        const namaHari = ["minggu", "senin", "selasa", "rabu", "kamis", "jumat", "sabtu"];

        if (!user || (user.role !== 'admin' && user.role !== 'humas')) {
            window.location.href = "index.html";
        } else if (user.role === 'humas') {
            document.getElementById('fab-container').style.display = 'block';
        }

        // --- UI LOGIC ---
        window.toggleFab = () => {
            const list = document.getElementById('fab-list');
            list.style.display = list.style.display === 'flex' ? 'none' : 'flex';
        };

        window.openModal = (type) => {
            closeModals();
            document.getElementById('modal-' + type).style.display = 'flex';
            if(type === 'akun') loadUsers();
            toggleFab();
        };

        window.closeModals = () => {
            document.getElementById('modal-warga').style.display = 'none';
            document.getElementById('modal-akun').style.display = 'none';
        };

        // --- DATA LOGIC ---
        window.loadAdminData = async function() {
            const hariIdx = document.getElementById('pilih-kelompok').value;
            if(hariIdx === "") return;
            const folderKel = namaHari[hariIdx];
            const snapWarga = await get(ref(db, `daftar_warga/all`));
            let listWarga = snapWarga.val() ? Object.values(snapWarga.val()).filter(n => n !== null) : [];
            listWarga.sort((a,b) => a.localeCompare(b));

            onValue(ref(db, `data_jimpitan/${folderKel}/2026/${new Date().getMonth()}`), (snap) => {
                let hB = "";
                listWarga.forEach(n => {
                    const clickAttr = (user.role === 'humas') ? `onclick="hapusWarga('${n}')" class="nama-col can-delete"` : `class="nama-col"`;
                    hB += `<tr><td ${clickAttr}>${n}</td><td colspan="10" style="color:#64748b">Klik hari untuk detail...</td></tr>`;
                });
                document.getElementById('body-rekap').innerHTML = hB;
            });
        };

        window.simpanWarga = async () => {
            const nama = document.getElementById('new-warga-nama').value.trim();
            const snap = await get(ref(db, `daftar_warga/all`));
            let list = snap.val() ? Object.values(snap.val()) : [];
            list.push(nama);
            await set(ref(db, `daftar_warga/all`), list);
            alert("Warga ditambah!");
            closeModals();
            loadAdminData();
        };

        window.hapusWarga = async (nama) => {
            if(confirm(`Hapus ${nama}?`)) {
                const snap = await get(ref(db, `daftar_warga/all`));
                let list = Object.values(snap.val()).filter(n => n !== nama);
                await set(ref(db, `daftar_warga/all`), list);
                loadAdminData();
            }
        };

        // --- ACCOUNT LOGIC ---
        window.loadUsers = () => {
            onValue(ref(db, 'users'), (snap) => {
                const data = snap.val();
                let html = "";
                if(data) {
                    Object.keys(data).forEach(u => {
                        html += `<div class="user-item">
                            <span><b>${u}</b> (${data[u].role})</span>
                            <button class="can-delete" onclick="hapusUser('${u}')" style="background:none; border:none;"><i class="fa-solid fa-trash"></i></button>
                        </div>`;
                    });
                }
                document.getElementById('user-list-container').innerHTML = html || "Belum ada akun";
            });
        };

        window.simpanUser = async () => {
            const u = document.getElementById('reg-user').value.toLowerCase().trim();
            const p = document.getElementById('reg-pass').value;
            const r = document.getElementById('reg-role').value;
            const k = document.getElementById('reg-kel').value;
            if(!u || !p) return alert("Isi data!");
            await set(ref(db, `users/${u}`), { password: p, role: r, kelompok: k });
            alert("Akun dibuat!");
        };

        window.hapusUser = (u) => confirm(`Hapus ${u}?`) && remove(ref(db, `users/${u}`));

        window.logout = () => { localStorage.clear(); window.location.href="index.html"; };
    </script>
</body>
</html>
