<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Warga | SEJIWA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { --bg: #0F172A; --card: #1E293B; --accent: #2DD4BF; --text: #F8FAFC; --danger: #F87171; --warning: #FBBF24; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; padding-bottom: 100px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid #334155; }
        .header h1 { font-size: 16px; margin: 0; color: var(--accent); font-weight: 800; }

        .table-container { background: var(--card); border-radius: 15px; border: 1px solid #334155; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; border-bottom: 1px solid #334155; text-align: left; }
        th { background: rgba(255,255,255,0.05); color: #94a3b8; font-size: 12px; text-transform: uppercase; }
        
        .aksi-btn { display: flex; gap: 15px; justify-content: flex-end; }
        .btn-edit { color: var(--warning); cursor: pointer; background: none; border: none; font-size: 16px; }
        .btn-hapus { color: var(--danger); cursor: pointer; background: none; border: none; font-size: 16px; }

        /* FAB & Modal */
        .fab-main { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; background: var(--accent); color: #0F172A; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 15px rgba(45,212,191,0.4); border: none; z-index: 100; cursor: pointer; }
        .fab-menu { position: fixed; bottom: 95px; right: 25px; display: none; flex-direction: column; gap: 10px; z-index: 99; }
        .btn-sub { background: var(--card); color: var(--accent); border: 1px solid var(--accent); padding: 12px 20px; border-radius: 30px; font-weight: bold; font-size: 13px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        .modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; background: rgba(15,23,42,0.95); align-items: center; justify-content: center; }
        .modal-content { background: var(--card); padding: 20px; border-radius: 15px; width: 90%; max-width: 400px; border: 1px solid var(--accent); }
        input, select { width: 100%; padding: 12px; margin: 10px 0; background: #0F172A; border: 1px solid #334155; color: white; border-radius: 10px; box-sizing: border-box; }
    </style>
</head>
<body>

    <div class="header">
        <h1>PANEL HUMAS</h1>
        <button onclick="logout()" style="background:#334155; color:var(--danger); border:none; padding:8px 12px; border-radius:8px; font-weight:bold;">OUT</button>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Nama Warga</th>
                    <th style="text-align: right;">Aksi</th>
                </tr>
            </thead>
            <tbody id="list-warga-body">
                <tr><td colspan="2" style="text-align:center; padding:40px; color:#94a3b8;">Memuat data...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="fab-container">
        <div id="fab-list" class="fab-menu">
            <button class="btn-sub" onclick="openModal('warga')"><i class="fa-solid fa-plus"></i> Tambah Warga</button>
            <button class="btn-sub" onclick="openModal('akun')"><i class="fa-solid fa-key"></i> Kelola Akun</button>
        </div>
        <button class="fab-main" onclick="toggleFab()"><i class="fa-solid fa-bars"></i></button>
    </div>

    <div id="modal-warga" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--accent); margin-top:0;">Tambah Warga Baru</h3>
            <input type="text" id="input-warga" placeholder="Ketik nama lengkap...">
            <button onclick="simpanWarga()" style="width:100%; padding:12px; background:var(--accent); border:none; border-radius:10px; font-weight:bold;">SIMPAN</button>
            <button onclick="closeModals()" style="width:100%; background:none; color:white; border:none; margin-top:15px;">Batal</button>
        </div>
    </div>

    <div id="modal-akun" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--accent); margin-top:0;">Daftarkan User Baru</h3>
            <input type="text" id="reg-user" placeholder="Username">
            <input type="text" id="reg-pass" placeholder="Password">
            <select id="reg-role">
                <option value="petugas">Petugas Ronda</option>
                <option value="admin">Admin Bendahara</option>
            </select>
            <input type="text" id="reg-kel" placeholder="Kelompok (senin/selasa/all)">
            <button onclick="simpanUser()" style="width:100%; padding:12px; background:var(--warning); border:none; border-radius:10px; font-weight:bold;">DAFTARKAN</button>
            <button onclick="closeModals()" style="width:100%; background:none; color:white; border:none; margin-top:15px;">Batal</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAxFU7HD_9uVHWGXEO0ZtJja6rdqKHurTk",
            authDomain: "jimpitan-sekawan.firebaseapp.com",
            projectId: "jimpitan-sekawan",
            storageBucket: "jimpitan-sekawan.firebasestorage.app",
            messagingSenderId: "634934433280",
            appId: "1:634934433280:web:abde3734bd277d3e9b2ae5",
            databaseURL: "https://jimpitan-sekawan-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- UI ACTIONS ---
        window.toggleFab = () => {
            const list = document.getElementById('fab-list');
            list.style.display = (list.style.display === 'flex') ? 'none' : 'flex';
        }
        window.openModal = (type) => {
            document.getElementById('modal-' + type).style.display = 'flex';
            document.getElementById('fab-list').style.display = 'none';
        }
        window.closeModals = () => {
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        }

        // --- LOAD DATA WARGA ---
        function loadData() {
            onValue(ref(db, `daftar_warga/all`), (snap) => {
                const data = snap.val();
                let html = "";
                if(data) {
                    const list = Object.values(data).filter(n => n !== null).sort();
                    list.forEach((nama, index) => {
                        html += `
                            <tr>
                                <td><b>${nama}</b></td>
                                <td class="aksi-btn">
                                    <button class="btn-edit" onclick="editWarga('${nama}')"><i class="fa-solid fa-pen-to-square"></i></button>
                                    <button class="btn-hapus" onclick="hapusWarga('${nama}')"><i class="fa-solid fa-trash"></i></button>
                                </td>
                            </tr>
                        `;
                    });
                }
                document.getElementById('list-warga-body').innerHTML = html || '<tr><td colspan="2">Data kosong</td></tr>';
            });
        }

        // --- CRUD ACTIONS ---
        window.simpanWarga = async () => {
            const nama = document.getElementById('input-warga').value.trim();
            if(!nama) return;
            const snap = await get(ref(db, `daftar_warga/all`));
            let list = snap.val() ? Object.values(snap.val()) : [];
            list.push(nama);
            await set(ref(db, `daftar_warga/all`), list);
            document.getElementById('input-warga').value = "";
            closeModals();
        }

        window.editWarga = async (namaLama) => {
            const namaBaru = prompt("Edit nama warga:", namaLama);
            if (namaBaru === null || namaBaru.trim() === "" || namaBaru === namaLama) return;
            
            const snap = await get(ref(db, `daftar_warga/all`));
            let list = Object.values(snap.val()).map(n => n === namaLama ? namaBaru.trim() : n);
            await set(ref(db, `daftar_warga/all`), list);
        }

        window.hapusWarga = async (nama) => {
            if(!confirm(`Hapus ${nama} dari daftar?`)) return;
            const snap = await get(ref(db, `daftar_warga/all`));
            let list = Object.values(snap.val()).filter(n => n !== nama);
            await set(ref(db, `daftar_warga/all`), list);
        }

        window.simpanUser = async () => {
            const u = document.getElementById('reg-user').value.toLowerCase().trim();
            const p = document.getElementById('reg-pass').value;
            if(!u || !p) return alert("Isi lengkap!");
            await set(ref(db, `users/${u}`), {
                password: p,
                role: document.getElementById('reg-role').value,
                kelompok: document.getElementById('reg-kel').value.toLowerCase()
            });
            alert("Akun berhasil dibuat!");
            closeModals();
        }

        window.logout = () => { localStorage.clear(); window.location.href="index.html"; };
        loadData();
    </script>
</body>
</html>
