<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Jimpitan Digital</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: sans-serif; background: #f4f7f9; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        input, button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background: #1a73e8; color: white; border: none; font-weight: bold; cursor: pointer; }
        #reader { width: 100%; border-radius: 10px; margin-bottom: 10px; }
        .hidden { display: none; }
        .rekap-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<div class="card">
    <div id="sec-login">
        <h2>ðŸ”‘ Login Jimpitan</h2>
        <input type="text" id="user" placeholder="Username">
        <input type="password" id="pass" placeholder="Password">
        <button onclick="login()">Masuk</button>
    </div>

    <div id="sec-scanner" class="hidden">
        <h3 id="info-user"></h3>
        <div id="reader"></div>
        <div id="status">Siap scan...</div>
        <div id="form-nominal" class="hidden">
            <p id="nama-warga" style="font-weight:bold"></p>
            <input type="number" id="nominal" value="2000">
            <button onclick="simpanData()" style="background:#28a745">Simpan</button>
        </div>
    </div>

    <div id="sec-admin" class="hidden">
        <h2>ðŸ“Š Dashboard RT</h2>
        <div style="background:#e8f5e9; padding:15px; border-radius:10px;">
            <span>Total Kas Terkumpul:</span>
            <h1 id="total-kas">Rp 0</h1>
        </div>
        <div id="list-rekap" style="margin-top:20px; text-align:left;"></div>
        <button onclick="location.reload()" style="background:#666">Keluar</button>
    </div>
</div>

<script>
    const scriptURL = 'URL_WEB_APP_GAS_KAMU'; // GANTI INI
    let currentKlp = "";
    let scannedName = "";
    const html5QrCode = new Html5Qrcode("reader");

    function login() {
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        fetch(scriptURL, { method: 'POST', body: JSON.stringify({ action: "login", username: u, password: p }) })
        .then(res => res.json()).then(data => {
            if (data.status === "success") {
                currentKlp = data.kelompok;
                document.getElementById('sec-login').classList.add('hidden');
                if (data.role === "admin") {
                    document.getElementById('sec-admin').classList.remove('hidden');
                    loadDashboard();
                } else {
                    document.getElementById('sec-scanner').classList.remove('hidden');
                    document.getElementById('info-user').innerText = "Petugas: " + currentKlp;
                    startScan();
                }
            } else { alert("User/Pass Salah!"); }
        });
    }

    function startScan() {
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
            scannedName = text;
            html5QrCode.stop();
            document.getElementById('reader').classList.add('hidden');
            document.getElementById('form-nominal').classList.remove('hidden');
            document.getElementById('nama-warga').innerText = "Rumah: " + text;
        });
    }

    function simpanData() {
        const nom = document.getElementById('nominal').value;
        fetch(scriptURL, { method: 'POST', body: JSON.stringify({ action: "simpan", nama: scannedName, nominal: nom, petugas: currentKlp }) })
        .then(res => res.text()).then(msg => { alert(msg); location.reload(); });
    }

    function loadDashboard() {
        fetch(scriptURL, { method: 'POST', body: JSON.stringify({ action: "getRekap" }) })
        .then(res => res.json()).then(data => {
            document.getElementById('total-kas').innerText = "Rp " + data.total.toLocaleString();
            let html = "";
            for (let k in data.detail) {
                html += `<div class="rekap-item"><span>${k}</span><b>Rp ${data.detail[k].toLocaleString()}</b></div>`;
            }
            document.getElementById('list-rekap').innerHTML = html;
        });
    }
</script>
</body>
</html>
