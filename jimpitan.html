<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan Jimpitan RT</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0F172A; --card: #1E293B; --accent: #00B894; --text: #F8FAFC; --border: #334155; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        
        /* Kontainer Kamera */
        #reader { width: 100%; max-width: 400px; border-radius: 20px; overflow: hidden; border: 2px solid var(--accent); background: #000; margin-bottom: 20px; position: relative; min-height: 250px; }
        
        .box { background: var(--card); padding: 20px; border-radius: 20px; width: 100%; max-width: 400px; box-sizing: border-box; border: 1px solid var(--border); }
        input { width: 100%; padding: 15px; border-radius: 12px; border: 2px solid var(--border); background: #0F172A; color: white; margin-bottom: 15px; box-sizing: border-box; text-align: center; font-size: 16px; font-weight: 600; }
        
        .label-sm { font-size: 12px; color: #94A3B8; margin-bottom: 8px; text-align: left; display: block; }
        .nominal-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-nom { flex: 1; padding: 12px 5px; border-radius: 10px; border: 2px solid var(--border); background: transparent; color: white; font-weight: 800; cursor: pointer; }
        .btn-nom.active { border-color: var(--accent); background: rgba(0, 184, 148, 0.1); color: var(--accent); }
        
        #nominal-input { border-color: var(--accent); font-size: 22px; color: var(--accent); background: #1e293b; }
        .btn-simpan { width: 100%; background: var(--accent); color: white; padding: 18px; border-radius: 12px; border: none; font-weight: 800; font-size: 18px; cursor: pointer; }
        .btn-simpan:disabled { background: #475569; cursor: not-allowed; }
        .footer-link { display: block; margin-top: 20px; color: #94A3B8; text-decoration: none; font-size: 14px; }
    </style>
</head>
<body>

    <h3>SCAN JIMPITAN</h3>
    
    <div id="reader"></div>

    <div class="box">
        <label class="label-sm">Nama Warga:</label>
        <input type="text" id="nama-warga" placeholder="Mencari Kamera..." readonly>
        
        <label class="label-sm">Nominal (Rp):</label>
        <div class="nominal-group">
            <button class="btn-nom active" onclick="setNominal(500, this)">500</button>
            <button class="btn-nom" onclick="setNominal(1000, this)">1000</button>
            <button class="btn-nom" onclick="setNominal(2000, this)">2000</button>
        </div>

        <input type="number" id="nominal-input" value="500">

        <button class="btn-simpan" id="btn-proses" onclick="simpanData()" disabled>SIMPAN DATA</button>
        <a href="dashboard.html" class="footer-link">← Kembali ke Dashboard</a>
    </div>

<script>
    const scriptURL = 'URL_WEB_APP_GAS_KAMU'; 
    const user = JSON.parse(localStorage.getItem("jimpitan_user")) || { kelompok: "Petugas" };
    const html5QrCode = new Html5Qrcode("reader");

    // Fungsi Mulai Kamera Otomatis
    function startCamera() {
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        
        // Menggunakan kamera belakang (environment) secara otomatis
        html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
        .catch(err => {
            console.error("Gagal buka kamera:", err);
            document.getElementById('nama-warga').placeholder = "Gagal akses kamera ❌";
        });
    }

    function onScanSuccess(decodedText) {
        document.getElementById('nama-warga').value = decodedText;
        document.getElementById('btn-proses').disabled = false;
        if (navigator.vibrate) navigator.vibrate(100);
        // Suara Beep simpel (optional)
    }

    function setNominal(val, btn) {
        document.getElementById('nominal-input').value = val;
        document.querySelectorAll('.btn-nom').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function simpanData() {
        const nama = document.getElementById('nama-warga').value;
        const nominal = document.getElementById('nominal-input').value;
        const btn = document.getElementById('btn-proses');

        btn.innerText = "⏳ MENYIMPAN...";
        btn.disabled = true;

        const cb = "cb_" + Math.round(Math.random() * 1000000);
        const s = document.createElement('script');
        window[cb] = (res) => {
            if(res.status === "success") {
                alert("Berhasil disimpan!");
                location.reload(); 
            } else {
                alert("Gagal: " + res.message);
                btn.innerText = "SIMPAN DATA";
                btn.disabled = false;
            }
            document.body.removeChild(s);
            delete window[cb];
        };
        
        s.src = `${scriptURL}?callback=${cb}&action=simpan&nama=${encodeURIComponent(nama)}&nominal=${nominal}&petugas=${encodeURIComponent(user.kelompok)}`;
        document.body.appendChild(s);
    }

    // JALANKAN KAMERA SAAT HALAMAN DIBUKA
    window.onload = startCamera;
</script>
</body>
</html>
